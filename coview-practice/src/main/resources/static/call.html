<!DOCTYPE html>
<html lang="en">
<head>
    <head>
        <meta charset="utf-8" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
        <title>영상통화를 하여봅시다</title>
    </head>
</head>
<body>
<div>
    <button onclick="outboundCall()">아웃바운드콜</button>
    <label>inviteKey:<input id="inviteKey" /></label>
    <button onclick="outboundAcceptCall();">acceptCall</button>
    <br />
</div>

</body>
<script>

  const { userId, isAgent } = new Proxy(
    new URLSearchParams(window.location.search),
    {
      get: (searchParams, prop) => searchParams.get(prop),
    }
  );

  let stompClient;
  const socket = new WebSocket("wss:/localhost:1236/stomp/call");
  stompClient = Stomp.over(socket);
  console.log(socket);
  const handleCallNotification = (payload) => {
    console.log(payload)
    const body = JSON.parse(payload.body);

    switch (body.type) {
      case "HELP_CALL": {
        const isAccept = confirm("3자 초대 승낙하실건가요?");
        acceptCall({ inviteKey: json.inviteKey, isAccept: isAccept });
        break;
      }
      case "OUTBOUND_CALL": {
        alert(json.inviteKey);
        break;
      }
      case "INBOUND_CALL": {
        const isAccept = confirm("인바운드 콜 승낙하실건가요?");
        acceptCall({ inviteKey: json.inviteKey, isAccept: isAccept });
        break;
      }
      case "TICKET": {
        console.log(json.ticket);
        const { roomId, accessToken } = json.ticket;
        openRoom({ roomId, jwt: accessToken  });
        break;
      }
      case "END_CALL": {
        console.log(json);
        break;
      }
    }
  }


  function outboundCall() {
    const endPoint = `/pub/call/requestCall`;
    const headers = {};
    const body = JSON.stringify({ callType: "OUTBOUND" });
    stompClient.send(endPoint, headers, body);
  }

  function outboundAcceptCall() {
    const inviteKey = document.querySelector("#inviteKey").value;
    acceptCall({ inviteKey, isAccept: true });
  }

  function helpCall() {
    const helperId = document.querySelector("#helperId").value;

    const endPoint = `/pub/call/requestCall`;
    const headers = {};
    const body = JSON.stringify({ callType: "HELP", helperId });
    stompClient.send(endPoint, headers, body);
  }

  function inboundCall() {
    const groupId = "1234"; // 개발중
    const endPoint = `/pub/call/requestCall`;
    const headers = {};
    const body = JSON.stringify({ callType: "INBOUND", groupId });
    stompClient.send(endPoint, headers, body);
  }

  const onConnect = () => {
    stompClient.subscribe(
      `/user/queue/call/callNotification`,
      handleCallNotification
    );

    stompClient.subscribe(
      `/user/queue/call/error`,
      (error) => { console.log(error) }
    );
  }

  const onError = (e) => {
    console.log("connect error : ", e);
  }

  stompClient.connect({}, onConnect, onError);

  function outboundCall() {
    const endPoint = `/pub/call/requestCall`;
    const headers = {};
    const body = JSON.stringify({ callType: "OUTBOUND" });
    stompClient.send(endPoint, headers, body);
  }

  function acceptCall({ inviteKey, isAccept }) {
    const endPoint = `/pub/call/acceptCall`;
    const headers = {};
    const body = JSON.stringify({ inviteKey, isAccept });
    stompClient.send(endPoint, headers, body);
  }

</script>
</html>